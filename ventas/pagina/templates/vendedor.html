<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendedor</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/vendedor.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/lateral.css' %}">


    


</head>
<body>
    <!-- Menú lateral de navegación -->
    <div class="sidebar">
        <div class="perfil">
            <div class="perfil-imagen"></div>
            <p>
                {% if user.is_authenticated %}
                    {{ user.username }}  <!-- Muestra el nombre de usuario logueado -->
                {% else %}
                    Invitado 
                {% endif %}
            </p>
        </div>
        <ul>
            <li><a href="{% url 'adminpage' %}">Página de Inicio</a></li>
            <li><a href="{% url 'vendedor' %}" class="active">Registro Inventario</a></li>
            <li><a href="{% url 'verPerfil' %}" class="btn btn-primary w-100">Ver Perfil</a></li>


            <li>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100">Cerrar Sesión</button>
                </form>
            </li>
        </ul>
    </div>

    

    

    <!-- Contenido principal -->
    <div class="main-content">
        <div class="header">
            

            {% if mensaje %}
                <div class="alert alert-info">
                    {{ mensaje }}
                </div>

                <!-- Código JavaScript para recargar la página -->
                <script type="text/javascript">
                    setTimeout(function() {
                        window.location.reload();  
                    }, 2000); 
                </script>
            {% endif %}

            <!-- Botón de subir archivo-->
            <form method="POST" enctype="multipart/form-data" action="{% url 'cargar_excel' %}">
                {% csrf_token %}
                <input type="file" name="archivo_excel" id="archivo_excel" required>
                <button type="submit">Cargar Excel</button>
            </form>
            
            


            <h1>Productos del Vendedor</h1>
            <!-- Botón de crear producto -->
            <a href="{% url 'crearproducto' %}" class="btn-create">
                <i class="fas fa-plus"></i> Crear producto
            </a>
            
            


        </div>

        <!-- Filtros -->
        <div class="filters">
            <form method="GET">
                <!-- Filtro de Marca -->
                <label for="marca">Marca:</label>
                <select name="marca" id="marca">
                    <option value="">Seleccione una marca</option>
                    {% for marca in marcas %}
                        <option value="{{ marca.id }}" {% if request.GET.marca == marca.id|stringformat:"s" %}selected{% endif %}>{{ marca.nombre }}</option>
                    {% endfor %}
                </select>

                <!-- Filtro de Categoría -->
                <label for="categoria">Categoría:</label>
                <select name="categoria" id="categoria">
                    <option value="">Seleccione una categoría</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if request.GET.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>

                <!-- Filtro de Fecha de Vencimiento -->
                <label for="fecha_vencimiento">Fecha de Vencimiento:</label>
                <input type="date" name="fecha_vencimiento" id="fecha_vencimiento" value="{{ request.GET.fecha_vencimiento }}">
                
                <!-- Botón de Filtro -->
                <button type="submit" class="btn-filter">Filtrar</button>
            </form>
        </div>

        <!-- Tabla de productos -->
        <table class="product-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Fecha Vencimiento</th> <!-- Nueva columna para fecha_vencimiento -->
                    <th>Categoría</th> <!-- Nueva columna para categoría -->
                    <th>Marca</th> <!-- Nueva columna para marca -->
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                {% for producto in page_obj %}
                    <tr>
                        <td>{{ producto.id }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td> $ {{ producto.precio|floatformat:0 }}</td>
                        <td>{{ producto.stock }}</td>
                        <td> {{ producto.fecha_vencimiento|date:"d/m/Y" }}</td> <!-- Mostrar la fecha de vencimiento -->
                        <td>{{ producto.categoria.nombre }}</td> <!-- Mostrar la categoría del producto -->
                        <td>{{ producto.marca.nombre }}</td> <!-- Mostrar la marca del producto -->
                        <td>
                            <!-- Botón de editar -->
                            <a href="{% url 'editar_producto' producto.id %}" class="btn-edit">
                                <i class="fas fa-pencil-alt"></i> Editar
                            </a>
                            <!-- Botón de eliminar -->
                            <a href="#" class="btn-edit btn-delete" data-id="{{ producto.id }}">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8">No hay productos disponibles.</td> <!-- Aumenté el colspan a 8 por la nueva columna -->
                    </tr>
                {% endfor %}
            </tbody>
        </table>


        <!-- Paginación -->
        <div class="pagination">
            <span class="page-link">
                {% if page_obj.has_previous %}
                    <a href="?page=1">Primera</a>
                    <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                {% endif %}
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">Última</a>
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Agregar el script de JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const productTableBody = document.getElementById("product-table-body");

            // Delegación de eventos para el botón de eliminar
            productTableBody.addEventListener("click", async function (event) {
                if (event.target.closest(".btn-delete")) {
                    const button = event.target.closest(".btn-delete");
                    const productId = button.getAttribute("data-id");

                    if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                        try {
                            const response = await fetch(`/eliminar_producto/${productId}/`, {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            });

                            if (response.ok) {
                                alert("Producto eliminado correctamente.");
                                // Eliminar la fila directamente del DOM
                                button.closest("tr").remove();
                            } else {
                                const errorData = await response.json();
                                alert(`Error al eliminar: ${errorData.message}`);
                            }
                        } catch (error) {
                            console.error("Error:", error);
                            alert("Hubo un problema al eliminar el producto.");
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
